---
title: "tug-of-war"
author: "M. H. Tessler"
date: "November 1, 2016"
output: html_document
---

```{r helpers, echo = F}
library(knitr)
knitr::opts_chunk$set(fig.crop = F,echo=T, 
                      warning=F, cache=F, 
                      message=F, sanitize = T)

library(rwebppl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(coda)
library(jsonlite)
rm(list=ls())

# # to get the maximum a posteriori value [MAP] (from samples)
# estimate_mode <- function(s) {
#   d <- density(s)
#   return(d$x[which.max(d$y)])
# }
# # upper bound of 95% credible interval
# hdi_upper<- function(s){
#   m <- HPDinterval(mcmc(s))
#   return(m["var1","upper"])
# }
# # lower bound of 95% credible interval
# hdi_lower<- function(s){
#   m <- HPDinterval(mcmc(s))
#   return(m["var1","lower"])
# }
```

## Tug of war model

Possible questions: 

1. "What is the strength of A?"
2. "Was A being lazy in match N?"
3. "Who will win: A vs. B?""

```{r towModel}
towModel <- '
// unpack data from R
var lazinessPrior = datafromR["lazinessPrior"][0]
var lazyPulling = datafromR["lazyPulling"][0]
var matchInfo = datafromR["matchInfo"][0]

var tugOfWarModel = function(){

    var strength = mem(function(person) {
      return gaussian(50, 10)
    })
    
    var lazy = mem(function(person, match) {
      return flip(lazinessPrior)
    })

    var lazyRandom = function() {
      return flip(lazinessPrior)
    }
    
    var pulling = function(person, match) {
      return lazy(person, match) ? strength(person) * 0.5 : strength(person)
    }
    
    var totalPulling = function(team, match) {
      return sum(map(function(person) {
        return pulling(person, match)
      }, team))
    }
    
    var winner = function(team1, team2, match) {
      return totalPulling(team1, match) > totalPulling(team2, match) ? team1 : team2
    }
    
    var beat = function(team1,team2, match) {
      return winner(team1,team2, match) == team1
    }

    var wouldBeat = function(player1, player2) {
      var p1 = lazyRandom() ? strength(player1) * 0.5 : strength(player1)
      var p2 = lazyRandom() ? strength(player2) * 0.5 : strength(player2)
      
      return p1 > p2
    }
    
    var conditions = function(i, len) {
      if (i < len) {
        if (matchInfo.games[i].winner == 1) {
          condition(beat(matchInfo.games[i].team1,
                        matchInfo.games[i].team2,
                        i + 1));
        } else if (matchInfo.games[i].winner == 2) {
          condition(beat(matchInfo.games[i].team2,
                        matchInfo.games[i].team1,
                        i + 1));
        }
        conditions(i + 1, len);
      }
    }

    conditions(0, matchInfo.games.length);


'
```

Define match information (the only information that's used in the model above is the winner/loser information, though the other information would be used in data analysis models).

Also, define the lazinessPrior and lazyPulling variables, package them up into `dataToWebPPL`, and pass it to the WebPPL model using the `data` and `data_var` options. (?webppl for more details)

```{r runTowModel}
scenarioID = 0
shouldPlot = TRUE
#runModel <- function(scenarioID, shouldPlot) {
  
  stim <- fromJSON("../../javascript/experiment_2/static/json/exp2_stim.json")
  scene = stim$scenarios[(scenarioID+1),]
  
  retObject = 'return { '
  
  
  
  for (i in 1:length(scene$questions[[1]])) {
    elementToAdd = ""
    if (scene$questions[[1]][i] == 0) {
      elementToAdd = paste0("'strength", scene$subjects[[1]][i, 1], "': strength(", scene$subjects[[1]][i, 1], ")")
    } else if (scene$questions[[1]][i] == 1) {
      elementToAdd = paste0("'laziness", scene$subjects[[1]][i, 1], scene$subjects[[1]][i, 2], "': lazy(", scene$subjects[[1]][i, 1], ", ", scene$subjects[[1]][i, 2], ")")
    } else if (scene$questions[[1]][i] == 2) {
      elementToAdd = paste0("'beat", scene$subjects[[1]][i, 1], scene$subjects[[1]][i, 2], "': wouldBeat(", scene$subjects[[1]][i, 1], ", ", scene$subjects[[1]][i, 2], ", 100)")
    }
  
    if (i < length(scene$questions[[1]])) {
      elementToAdd = paste0(elementToAdd, ", ")
    }
    retObject = paste0(retObject, elementToAdd)
  }
  
  retObject = paste0(retObject, "}}")
  
  newModel = paste0(towModel, retObject)
  
  dataToWebPPL = list(lazinessPrior = 0.3, 
                      lazyPulling = 0.5,
                      matchInfo = scene)
  
  rs <- webppl(program_code = newModel, 
               model_var = "tugOfWarModel",
    inference_opts = list(method = 'rejection', samples = 1000),
    data = dataToWebPPL,
    data_var = "datafromR",
    output_format = "samples"
  )
  
  # Plotting the results
  rs.tidy <- rs %>%
    gather(key, val)
  
  rs.tidy$val <- as.double(rs.tidy$val)
  
  if (shouldPlot) {
    
    for (i in names(rs)) {
      print(mean(rs[[i]]))
    }
    
    ggplot(rs.tidy, aes( x = val ))+
    geom_histogram() +
    facet_wrap(~key, scales = 'free') 
    
  } else {
    #return(mean(rs$strength1))
  }
  
  
#}

df <- data.frame(strength=integer())

#You can run the model on just one scenario in stim by calling runModel(id, TRUE)
  
#runModel(30, TRUE)
#getMeans(21:30)
```

```{r getModelPredictions}
stim <- fromJSON("../../javascript/experiment_2/static/json/exp2_stim.json")

firstGame = 0
lastGame = 1

df.strength <- data.frame(id=character(), rating=double(), stringsAsFactors = FALSE)
df.lazy <- data.frame(id=character(), rating=double(), stringsAsFactors = FALSE)
df.wouldwin <- data.frame(id=character(), rating=double(), stringsAsFactors = FALSE)

sIndex = 0
lIndex = 0
wIndex = 0

for (x in (firstGame + 1):(lastGame + 1)) {
  scene = stim$scenarios[x,]
  
  for (i in 1:length(scene$questions[[1]])) {
    retObject = 'return { '
    elementToAdd = ""
    ide = "0"
    if (scene$questions[[1]][i] == 0) {
      sIndex = sIndex + 1
      elementToAdd = paste0("'strength", scene$subjects[[1]][i, 1], "': strength(", scene$subjects[[1]][i, 1], ")")
      ide = paste0(x-1, "-", scene$subjects[[1]][i, 1])
    } else if (scene$questions[[1]][i] == 1) {
      lIndex = lIndex + 1
      elementToAdd = paste0("'laziness", scene$subjects[[1]][i, 1], scene$subjects[[1]][i, 2], "': lazy(", scene$subjects[[1]][i, 1], ", ", scene$subjects[[1]][i, 2], ")")
      ide = paste0(x-1, '\n')
      for (game in 1:length(scene$games[[1]]$winner)) {
        for (player in 1:length(scene$games[[1]]$team1[[game]])) {
          ide = paste0(ide, scene$games[[1]]$team1[[game]][player])
          if (scene$games[[1]]$team1[[game]][player] == scene$subjects[[1]][i, 1] && game == scene$subjects[[1]][i, 2]) {
            ide = paste0(ide, '? ')
          } else {
            ide = paste0(ide, ' ')
          }
        }
        if (scene$games[[1]]$winner[[game]] == 1) {
          ide = paste0(ide, '>')
        } else {
          ide = paste0(ide, '<')
        }
        for (player in 1:length(scene$games[[1]]$team2[[game]])) {
          ide = paste0(ide, ' ', scene$games[[1]]$team2[[game]][player])
          if (scene$games[[1]]$team2[[game]][player] == scene$subjects[[1]][i, 1] && game == scene$subjects[[1]][i, 2]) {
            ide = paste0(ide, '?')
          } else {
            ide = paste0(ide)
          }
        }
        ide = paste0(ide, '\n')
      }
    } else if (scene$questions[[1]][i] == 2) {
      wIndex = wIndex + 1
      elementToAdd = paste0("'beat", scene$subjects[[1]][i, 1], scene$subjects[[1]][i, 2], "': wouldBeat(", scene$subjects[[1]][i, 1], ", ", scene$subjects[[1]][i, 2], ")")
      ide = paste0(x-1, "-", scene$subjects[[1]][i, 1],",", scene$subjects[[1]][i, 2])
    }
  
    if (i < length(scene$questions[[1]])) {
      elementToAdd = paste0(elementToAdd, ", ")
    }
    retObject = paste0(retObject, elementToAdd)
  
    retObject = paste0(retObject, "}}")
  
    newModel = paste0(towModel, retObject)
  
    dataToWebPPL = list(lazinessPrior = 0.3, 
                        lazyPulling = 0.5,
                        matchInfo = scene)
  
    rs <- webppl(program_code = newModel, 
                 model_var = "tugOfWarModel",
      inference_opts = list(method = 'rejection', samples = 1000),
      data = dataToWebPPL,
      data_var = "datafromR",
      output_format = "samples"
    )
    
    rs.tidy <- rs %>%
    gather(key, val)
  
    rs.tidy$val <- as.double(rs.tidy$val)
    
    if (scene$questions[[1]][i] == 0) {
      df.strength[sIndex,] <- c(ide, mean(rs.tidy$val))
    } else if (scene$questions[[1]][i] == 1) {
      df.lazy[lIndex,] <- c(ide, mean(rs.tidy$val))
    } else if (scene$questions[[1]][i] == 2) {
      df.wouldwin[wIndex,] <- c(ide, mean(rs.tidy$val))
    }
  }
}

```

```{r plotResults}

#df.plot = df.results %>% 
#  mutate(rating = rating-50) %>%
#  mutate(id = as.factor(id),
#        winner = factor(winner,levels = c("1","2"),labels = c('Win', "Loss")),
#         rating = ifelse(winner == "Loss", rating*-1, rating))

ggplot(df.strength,aes(x = id, y = as.numeric(rating)))+
  stat_summary(fun.y = 'identity',geom='bar',color = 'black',fill = 'gray80')+
  labs(y = 'strength', x = 'tournament-player')+
  theme_bw()+
  scale_y_continuous(limits = c(0,100))+
  theme(text = element_text(size = 10),
        panel.grid = element_blank())

ggplot(df.lazy,aes(x = id, y = rating))+
  stat_summary(fun.y = 'identity',geom='bar',color = 'black',fill = 'gray80')+
  labs(y = 'probability of laziness', x = 'tournament-player,match')+
  theme_bw()+
  theme(text = element_text(size = 10),
        panel.grid = element_blank())

ggplot(df.wouldwin,aes(x = id, y = rating))+
  stat_summary(fun.y = 'identity',geom='bar',color = 'black',fill = 'gray80')+
  labs(y = 'probability of player 1 win', x = 'tournament-player1,player2')+
  theme_bw()+
  theme(text = element_text(size = 10),
        panel.grid = element_blank())

#ggsave('../../../figures/plots/model1_bars.pdf',width=10,height=6)

```

```{r saveResults}

save(list = c("df.results"),file = 'exp1_predictions.RData')

```